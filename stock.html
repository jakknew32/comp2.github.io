<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #21262d; --border: #30363d;
    --accent: #58a6ff; --accent2: #3fb950; --warn: #d29922; --danger: #f85149;
    --text: #e6edf3; --text2: #8b949e; --text3: #6e7681;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 15px; }

  nav { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; }
  .nav-brand { font-size: 18px; font-weight: 700; color: var(--accent); font-family: 'IBM Plex Mono', monospace; padding: 16px 24px 16px 0; border-right: 1px solid var(--border); margin-right: 8px; letter-spacing: -0.5px; }
  .nav-tabs { display: flex; }
  .nav-tab { padding: 18px 20px; cursor: pointer; color: var(--text2); font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; user-select: none; }
  .nav-tab:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  main { padding: 28px 32px; max-width: 1300px; margin: 0 auto; }
  .page { display: none; animation: fadeIn 0.2s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; } }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
  .stat-label { font-size: 12px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .stat-value { font-size: 28px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; }
  .stat-value.blue { color: var(--accent); } .stat-value.green { color: var(--accent2); } .stat-value.warn { color: var(--warn); }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .section-title { font-size: 16px; font-weight: 600; }

  .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid; cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 14px; font-weight: 500; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #000; }
  .btn-primary:hover { background: #79b8ff; }
  .btn-success { background: var(--accent2); border-color: var(--accent2); color: #000; }
  .btn-success:hover { background: #56d364; }
  .btn-outline { background: transparent; border-color: var(--border); color: var(--text); }
  .btn-outline:hover { background: var(--surface2); }
  .btn-danger { background: transparent; border-color: var(--danger); color: var(--danger); }
  .btn-danger:hover { background: rgba(248,81,73,0.1); }
  .btn-sm { padding: 4px 10px; font-size: 13px; }

  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
  th { padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 13px 16px; font-size: 14px; border-bottom: 1px solid rgba(48,54,61,0.5); }
  tr:last-child td { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }

  .badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 12px; font-weight: 600; }
  .badge-green { background: rgba(63,185,80,0.15); color: var(--accent2); }
  .badge-warn { background: rgba(210,153,34,0.15); color: var(--warn); }
  .badge-red { background: rgba(248,81,73,0.15); color: var(--danger); }
  .badge-blue { background: rgba(88,166,255,0.15); color: var(--accent); }

  .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-bg.show { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 500px; max-width: 95vw; animation: modalIn 0.2s ease; }
  @keyframes modalIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal-title { font-size: 16px; font-weight: 600; }
  .modal-close { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 20px; line-height: 1; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }

  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 13px; font-weight: 500; color: var(--text2); margin-bottom: 6px; }
  input, select, textarea { width: 100%; padding: 9px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Sarabun', sans-serif; font-size: 14px; transition: border-color 0.15s; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  select option { background: var(--surface2); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .code-hint { font-size: 11px; color: var(--text3); margin-top: 4px; font-family: 'IBM Plex Mono', monospace; }

  .search-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .search-bar input { flex: 1; min-width: 180px; }

  .alert { background: rgba(210,153,34,0.08); border: 1px solid rgba(210,153,34,0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; color: var(--warn); font-size: 14px; display: flex; align-items: center; gap: 8px; }

  /* REPORT PREVIEW */
  .report-preview { background: white; color: #111; border-radius: 8px; padding: 28px 36px; font-family: 'Sarabun', sans-serif; font-size: 13px; margin-top: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.4); }
  .report-preview table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
  .report-preview th, .report-preview td { border: 1px solid #ccc; padding: 5px 8px; }
  .report-preview th { background: #eef2f7; font-weight: 700; font-size: 11px; text-align: center; color: #333; }
  .report-preview td { font-size: 11px; color: #222; }
  .r-header { text-align: center; margin-bottom: 18px; border-bottom: 2px solid #222; padding-bottom: 12px; }
  .r-title { font-size: 17px; font-weight: 700; color: #111; }
  .r-sub { font-size: 11px; color: #555; margin-top: 4px; }
  .r-org { font-size: 12px; color: #333; margin-bottom: 2px; }
  .r-section { font-size: 12px; font-weight: 700; margin: 16px 0 6px; color: #1a3a6e; border-left: 3px solid #2563eb; padding-left: 8px; }
  .r-summary { margin-top: 12px; display: flex; justify-content: flex-end; }
  .r-summary table { width: auto; border: 1px solid #ccc; }
  .r-summary td { padding: 4px 14px; border: 1px solid #ddd; font-size: 11px; }
  .r-total { background: #dbeafe !important; font-weight: 700; }
  .page-break { page-break-before: always; margin: 0; padding: 0; border: none; }

  /* PRINT */
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    body { background: white !important; color: #000 !important; }
    nav, .no-print { display: none !important; }
    main { padding: 0 !important; max-width: 100% !important; }
    .page { display: none !important; }
    #page-report { display: block !important; }
    .report-preview { box-shadow: none !important; border-radius: 0 !important; padding: 0 !important; }
    .page-break { page-break-before: always; display: block; }
  }
  @page { size: A4 portrait; margin: 10mm 12mm; }
</style>
</head>
<body>

<nav>
  <div class="nav-brand">STOCK‚Ä¢SYS</div>
  <div class="nav-tabs">
    <div class="nav-tab active">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
    <div class="nav-tab">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    <div class="nav-tab">üöö ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    <div class="nav-tab">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
  </div>
</nav>

<main>

  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="stats-grid" id="statsGrid"></div>
    <div id="lowStockAlert"></div>
    <div class="section-header"><div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="dashboardTable"></tbody>
      </table>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="page-products" class="page">
    <div class="section-header">
      <div class="section-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <button class="btn btn-primary" onclick="openAddProduct()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div class="search-bar no-print">
      <input type="text" id="searchProduct" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="renderProducts()">
      <select id="filterCategory" onchange="renderProducts()"><option value="">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏™‡∏ï‡πä‡∏≠‡∏Å</th><th>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚â§</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
        <tbody id="productsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- DISPATCH -->
  <div id="page-dispatch" class="page">
    <div class="section-header">
      <div class="section-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <button class="btn btn-success" onclick="openDispatch()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</button>
    </div>
    <div class="search-bar no-print">
      <input type="text" id="searchDispatch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="renderDispatch()">
      <select id="filterDest" onchange="renderDispatch()"><option value="">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th></th></tr></thead>
        <tbody id="dispatchTable"></tbody>
      </table>
    </div>
  </div>

  <!-- REPORT -->
  <div id="page-report" class="page">
    <div class="section-header no-print">
      <div class="section-title">‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
      <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF (A4)</button>
    </div>
    <div class="search-bar no-print">
      <select id="reportType" onchange="renderReport()" style="width:240px;">
        <option value="stock">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option value="dispatch">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option value="dept_month">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
        <option value="lowstock">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</option>
      </select>
      <input type="date" id="rDateFrom" onchange="renderReport()" style="width:148px;" title="‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
      <span style="align-self:center;color:var(--text2)">‚Äì</span>
      <input type="date" id="rDateTo" onchange="renderReport()" style="width:148px;" title="‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
      <select id="rProduct" onchange="renderReport()" style="width:180px;"><option value="">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
      <select id="rDest" onchange="renderReport()" style="width:160px;"><option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option></select>
    </div>
    <div id="reportOutput"></div>
  </div>

</main>

<!-- MODAL: PRODUCT -->
<div class="modal-bg" id="modalProduct">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalProductTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
      <button class="modal-close" onclick="closeModal('modalProduct')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pId">
      <div class="form-row">
        <div class="form-group">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <input type="text" id="pCode" placeholder="‡∏≠‡∏≠‡πÇ‡∏ï‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á" style="font-family:'IBM Plex Mono',monospace;font-size:13px;">
          <div class="code-hint" id="codeHint"></div>
        </div>
        <div class="form-group">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *</label>
          <input type="text" id="pCategory" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô" list="catList">
          <datalist id="catList"></datalist>
        </div>
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
        <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å</label>
          <input type="number" id="pStock" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚â§</label>
          <input type="number" id="pMinStock" min="0" placeholder="10">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
          <input type="text" id="pUnit" placeholder="‡∏ä‡∏¥‡πâ‡∏ô / ‡∏Å‡∏•‡πà‡∏≠‡∏á / ‡πÅ‡∏û‡πá‡∏Ñ">
        </div>
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="pCost" min="0" step="0.01" placeholder="0.00">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modalProduct')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveProduct()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: DISPATCH -->
<div class="modal-bg" id="modalDispatch">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
      <button class="modal-close" onclick="closeModal('modalDispatch')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
        <select id="dProduct"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label>
          <input type="number" id="dQty" min="1" placeholder="0">
        </div>
        <div class="form-group">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ *</label>
          <input type="date" id="dDate">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á *</label>
          <input type="text" id="dDest" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" list="destList">
          <datalist id="destList"></datalist>
        </div>
        <div class="form-group">
          <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
          <input type="text" id="dReceiver" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö">
        </div>
      </div>
      <div class="form-group">
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="dNote" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modalDispatch')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="saveDispatch()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</button>
    </div>
  </div>
</div>

<script>
let products = JSON.parse(localStorage.getItem('products') || '[]');
let dispatches = JSON.parse(localStorage.getItem('dispatches') || '[]');

if (products.length === 0) {
  products = [
    { id:1, code:'PRD-0001', name:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 80g', category:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©', stock:150, minStock:20, unit:'‡∏£‡∏µ‡∏°', cost:120 },
    { id:2, code:'PRD-0002', name:'‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡∏•‡∏π‡∏Å‡∏•‡∏∑‡πà‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', category:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', stock:85, minStock:30, unit:'‡∏î‡πâ‡∏≤‡∏°', cost:8 },
    { id:3, code:'PRD-0003', name:'‡πÅ‡∏ü‡πâ‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ A4', category:'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', stock:12, minStock:15, unit:'‡∏≠‡∏±‡∏ô', cost:35 },
    { id:4, code:'PRD-0004', name:'‡∏Å‡∏≤‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡πá‡∏Å‡∏ã‡πå', category:'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', stock:30, minStock:10, unit:'‡∏Ç‡∏ß‡∏î', cost:25 },
    { id:5, code:'PRD-0005', name:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÇ‡∏ô‡πâ‡∏ï Post-it', category:'‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©', stock:8, minStock:10, unit:'‡πÅ‡∏û‡πá‡∏Ñ', cost:45 },
  ];
  dispatches = [
    {id:1,productId:1,qty:10,date:'2025-01-15',dest:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',receiver:'‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',note:''},
    {id:2,productId:2,qty:20,date:'2025-01-16',dest:'‡∏ù‡πà‡∏≤‡∏¢ IT',receiver:'‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',note:'‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ'},
    {id:3,productId:1,qty:5, date:'2025-01-18',dest:'‡∏ù‡πà‡∏≤‡∏¢ HR',receiver:'‡∏°‡∏≤‡∏•‡∏µ ‡∏™‡∏∏‡∏î‡∏™‡∏ß‡∏¢',note:''},
    {id:4,productId:3,qty:3, date:'2025-01-20',dest:'‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢',receiver:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡πÉ‡∏à',note:''},
    {id:5,productId:2,qty:12,date:'2025-02-05',dest:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',receiver:'‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',note:''},
    {id:6,productId:1,qty:8, date:'2025-02-10',dest:'‡∏ù‡πà‡∏≤‡∏¢ IT',receiver:'‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',note:''},
    {id:7,productId:4,qty:5, date:'2025-02-14',dest:'‡∏ù‡πà‡∏≤‡∏¢ HR',receiver:'‡∏°‡∏≤‡∏•‡∏µ ‡∏™‡∏∏‡∏î‡∏™‡∏ß‡∏¢',note:''},
    {id:8,productId:5,qty:4, date:'2025-03-02',dest:'‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢',receiver:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡πÉ‡∏à',note:''},
    {id:9,productId:1,qty:6, date:'2025-03-08',dest:'‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',receiver:'‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ',note:''},
    {id:10,productId:3,qty:2,date:'2025-03-15',dest:'‡∏ù‡πà‡∏≤‡∏¢ IT',receiver:'‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏£‡∏±‡∏Å‡∏á‡∏≤‡∏ô',note:''},
  ];
  save();
}

function save() {
  localStorage.setItem('products', JSON.stringify(products));
  localStorage.setItem('dispatches', JSON.stringify(dispatches));
}

function getNextCode() {
  if (!products.length) return 'PRD-0001';
  const nums = products.map(p => { const m = p.code.match(/(\d+)$/); return m ? parseInt(m[1]) : 0; });
  return 'PRD-' + String(Math.max(...nums) + 1).padStart(4, '0');
}

let nextPid = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
let nextDid = dispatches.length ? Math.max(...dispatches.map(d => d.id)) + 1 : 1;

// NAV
document.querySelectorAll('.nav-tab').forEach((t, i) => {
  const pages = ['dashboard','products','dispatch','report'];
  t.onclick = () => {
    document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pages[i]).classList.add('active');
    if (pages[i]==='dashboard') renderDashboard();
    if (pages[i]==='products') renderProducts();
    if (pages[i]==='dispatch') renderDispatch();
    if (pages[i]==='report') { populateReportFilters(); renderReport(); }
  };
});

// DASHBOARD
function renderDashboard() {
  const lowStock = products.filter(p => p.stock <= p.minStock).length;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card"><div class="stat-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="stat-value blue">${products.length}</div></div>
    <div class="stat-card"><div class="stat-label">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°</div><div class="stat-value green">${products.reduce((a,p)=>a+p.stock,0).toLocaleString()}</div></div>
    <div class="stat-card"><div class="stat-label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</div><div class="stat-value ${lowStock>0?'warn':'green'}">${lowStock}</div></div>
    <div class="stat-card"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-value blue">${dispatches.length}</div></div>
  `;
  const low = products.filter(p => p.stock <= p.minStock);
  document.getElementById('lowStockAlert').innerHTML = low.length
    ? `<div class="alert">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥ ${low.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${low.map(p=>p.name).join(', ')}</div>` : '';
  document.getElementById('dashboardTable').innerHTML = products.map(p => {
    const b = p.stock===0?'<span class="badge badge-red">‡∏´‡∏°‡∏î</span>':p.stock<=p.minStock?'<span class="badge badge-warn">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>':'<span class="badge badge-green">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
    return `<tr>
      <td><code style="color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:12px">${p.code}</code></td>
      <td>${p.name}</td><td>${p.category}</td>
      <td style="font-weight:600">${p.stock.toLocaleString()}</td>
      <td style="color:var(--text2)">${p.unit}</td>
      <td style="font-family:'IBM Plex Mono',monospace">${p.cost.toFixed(2)}</td>
      <td>${b}</td>
    </tr>`;
  }).join('');
}

// PRODUCTS
function renderProducts() {
  const q = (document.getElementById('searchProduct')?.value||'').toLowerCase();
  const cat = document.getElementById('filterCategory')?.value||'';
  const cats = [...new Set(products.map(p=>p.category))];
  const sel = document.getElementById('filterCategory');
  if(sel){ const cur=sel.value; sel.innerHTML='<option value="">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'+cats.map(c=>`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`).join(''); }
  document.getElementById('catList').innerHTML = cats.map(c=>`<option value="${c}">`).join('');
  const filtered = products.filter(p=>(p.name.toLowerCase().includes(q)||p.code.toLowerCase().includes(q))&&(!cat||p.category===cat));
  document.getElementById('productsTable').innerHTML = filtered.map(p => {
    const sc = p.stock===0?'red':p.stock<=p.minStock?'warn':'green';
    return `<tr>
      <td><code style="color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:12px">${p.code}</code></td>
      <td><strong>${p.name}</strong></td>
      <td><span class="badge badge-blue">${p.category}</span></td>
      <td style="color:var(--${sc});font-weight:700;font-family:'IBM Plex Mono',monospace">${p.stock}</td>
      <td style="color:var(--text2)">${p.minStock}</td>
      <td style="color:var(--text2)">${p.unit}</td>
      <td style="font-family:'IBM Plex Mono',monospace">${p.cost.toFixed(2)}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-outline btn-sm" onclick="openEditProduct(${p.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:32px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
}

function openAddProduct() {
  document.getElementById('modalProductTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
  document.getElementById('pId').value = '';
  const ac = getNextCode();
  document.getElementById('pCode').value = ac;
  document.getElementById('codeHint').textContent = '‚Üí ‡∏≠‡∏≠‡πÇ‡∏ï‡πâ: ' + ac;
  ['pName','pCategory','pUnit'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('pStock').value=''; document.getElementById('pMinStock').value=''; document.getElementById('pCost').value='';
  document.getElementById('catList').innerHTML = [...new Set(products.map(p=>p.category))].map(c=>`<option value="${c}">`).join('');
  openModal('modalProduct');
}

function openEditProduct(id) {
  const p = products.find(x=>x.id===id); if(!p) return;
  document.getElementById('modalProductTitle').textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
  document.getElementById('pId').value=p.id; document.getElementById('pCode').value=p.code; document.getElementById('codeHint').textContent='';
  document.getElementById('pName').value=p.name; document.getElementById('pCategory').value=p.category;
  document.getElementById('pStock').value=p.stock; document.getElementById('pMinStock').value=p.minStock;
  document.getElementById('pUnit').value=p.unit; document.getElementById('pCost').value=p.cost;
  openModal('modalProduct');
}

function saveProduct() {
  const id = document.getElementById('pId').value;
  const code = document.getElementById('pCode').value.trim() || getNextCode();
  const name = document.getElementById('pName').value.trim();
  const category = document.getElementById('pCategory').value.trim();
  const stock = parseInt(document.getElementById('pStock').value)||0;
  const minStock = parseInt(document.getElementById('pMinStock').value)||0;
  const unit = document.getElementById('pUnit').value.trim();
  const cost = parseFloat(document.getElementById('pCost').value)||0;
  if(!name||!category){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');return;}
  if(!id && products.some(p=>p.code===code)){alert('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');return;}
  if(id){Object.assign(products.find(x=>x.id==id),{code,name,category,stock,minStock,unit,cost});}
  else{products.push({id:nextPid++,code,name,category,stock,minStock,unit,cost});}
  save(); closeModal('modalProduct'); renderProducts();
}

function deleteProduct(id) {
  if(!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?'))return;
  products=products.filter(p=>p.id!==id); save(); renderProducts();
}

// DISPATCH
function renderDispatch() {
  const q=(document.getElementById('searchDispatch')?.value||'').toLowerCase();
  const dest=document.getElementById('filterDest')?.value||'';
  const dests=[...new Set(dispatches.map(d=>d.dest))];
  const sel=document.getElementById('filterDest');
  if(sel){const cur=sel.value; sel.innerHTML='<option value="">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'+dests.map(d=>`<option value="${d}" ${d===cur?'selected':''}>${d}</option>`).join('');}
  document.getElementById('destList').innerHTML=dests.map(d=>`<option value="${d}">`).join('');
  const filtered=dispatches.filter(d=>{
    const p=products.find(x=>x.id===d.productId);
    const name=p?p.name.toLowerCase():'';
    return (name.includes(q)||d.dest.toLowerCase().includes(q)||(d.receiver||'').toLowerCase().includes(q))&&(!dest||d.dest===dest);
  }).sort((a,b)=>b.date.localeCompare(a.date));
  document.getElementById('dispatchTable').innerHTML=filtered.map(d=>{
    const p=products.find(x=>x.id===d.productId);
    return `<tr>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:12px">${d.date}</td>
      <td><code style="color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:12px">${p?p.code:'-'}</code></td>
      <td>${p?p.name:'-'}</td>
      <td style="font-weight:700;color:var(--danger)">${d.qty}</td>
      <td style="color:var(--text2)">${p?p.unit:'-'}</td>
      <td><span class="badge badge-blue">${d.dest}</span></td>
      <td>${d.receiver||'-'}</td><td style="color:var(--text2)">${d.note||'-'}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteDispatch(${d.id})">üóëÔ∏è</button></td>
    </tr>`;
  }).join('')||'<tr><td colspan="9" style="text-align:center;color:var(--text3);padding:32px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}

function openDispatch() {
  document.getElementById('dProduct').innerHTML=products.map(p=>`<option value="${p.id}">${p.code} ‚Äì ${p.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock} ${p.unit})</option>`).join('');
  document.getElementById('dDate').value=new Date().toISOString().split('T')[0];
  ['dQty','dDest','dReceiver','dNote'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('destList').innerHTML=[...new Set(dispatches.map(d=>d.dest))].map(d=>`<option value="${d}">`).join('');
  openModal('modalDispatch');
}

function saveDispatch() {
  const productId=parseInt(document.getElementById('dProduct').value);
  const qty=parseInt(document.getElementById('dQty').value)||0;
  const date=document.getElementById('dDate').value;
  const dest=document.getElementById('dDest').value.trim();
  const receiver=document.getElementById('dReceiver').value.trim();
  const note=document.getElementById('dNote').value.trim();
  if(!productId||!qty||!date||!dest){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô');return;}
  const p=products.find(x=>x.id===productId); if(!p)return;
  if(qty>p.stock){alert(`‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠! ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ${p.unit}`);return;}
  p.stock-=qty;
  dispatches.push({id:nextDid++,productId,qty,date,dest,receiver,note});
  save(); closeModal('modalDispatch'); renderDispatch();
}

function deleteDispatch(id) {
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö'))return;
  const d=dispatches.find(x=>x.id===id);
  if(d){const p=products.find(x=>x.id===d.productId);if(p)p.stock+=d.qty;}
  dispatches=dispatches.filter(x=>x.id!==id); save(); renderDispatch();
}

// REPORT
const MTH=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
const MTHF=['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

function populateReportFilters() {
  document.getElementById('rProduct').innerHTML='<option value="">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'+products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  const dests=[...new Set(dispatches.map(d=>d.dest))];
  document.getElementById('rDest').innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>'+dests.map(d=>`<option value="${d}">${d}</option>`).join('');
}

function renderReport() {
  const type=document.getElementById('reportType').value;
  const df=document.getElementById('rDateFrom').value;
  const dt=document.getElementById('rDateTo').value;
  const fp=document.getElementById('rProduct').value;
  const fd=document.getElementById('rDest').value;
  const now=new Date().toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});
  const dRange=(df||dt)?`${df||'...'} ‡∏ñ‡∏∂‡∏á ${dt||'...'}`:'-';

  function filterD(list){
    return list.filter(d=>{
      if(fp&&d.productId!=fp)return false;
      if(fd&&d.dest!==fd)return false;
      if(df&&d.date<df)return false;
      if(dt&&d.date>dt)return false;
      return true;
    });
  }

  const rh = (title, sub) => `<div class="r-header"><div class="r-title">${title}</div><div class="r-sub">${sub}</div></div>`;

  let html = '<div class="report-preview">';

  // STOCK
  if(type==='stock'){
    const data=products.filter(p=>!fp||p.id==fp);
    const tStock=data.reduce((a,p)=>a+p.stock,0);
    const tVal=data.reduce((a,p)=>a+p.stock*p.cost,0);
    html+=rh('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: '+now);
    html+=`<table><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;
    html+=data.map((p,i)=>`<tr><td style="text-align:center">${i+1}</td><td style="font-family:'IBM Plex Mono',monospace">${p.code}</td><td>${p.name}</td><td style="text-align:center">${p.category}</td><td style="text-align:right;font-weight:700">${p.stock.toLocaleString()}</td><td style="text-align:right">${p.minStock}</td><td style="text-align:center">${p.unit}</td><td style="text-align:right">${p.cost.toLocaleString('th-TH',{minimumFractionDigits:2})}</td><td style="text-align:right">${(p.stock*p.cost).toLocaleString('th-TH',{minimumFractionDigits:2})}</td></tr>`).join('');
    html+=`</tbody></table>`;
    html+=`<div class="r-summary"><table><tr><td>${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ &nbsp; ‡∏£‡∏ß‡∏° ${tStock.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</td></tr><tr class="r-total"><td>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ${tVal.toLocaleString('th-TH',{minimumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó</td></tr></table></div>`;
  }

  // DISPATCH
  else if(type==='dispatch'){
    const data=filterD(dispatches).sort((a,b)=>a.date.localeCompare(b.date));
    const tq=data.reduce((a,d)=>a+d.qty,0);
    html+=rh('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',`‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dRange} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${now}`);
    html+=`<table><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>`;
    html+=data.map((d,i)=>{const p=products.find(x=>x.id===d.productId); return`<tr><td style="text-align:center">${i+1}</td><td style="font-family:'IBM Plex Mono',monospace;white-space:nowrap">${d.date}</td><td style="font-family:'IBM Plex Mono',monospace">${p?p.code:'-'}</td><td>${p?p.name:'-'}</td><td style="text-align:right;font-weight:700">${d.qty}</td><td style="text-align:center">${p?p.unit:'-'}</td><td>${d.dest}</td><td>${d.receiver||'-'}</td><td style="color:#666">${d.note||'-'}</td></tr>`;}).join('');
    html+=`</tbody></table>`;
    html+=`<div class="r-summary"><table><tr><td>${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr><tr class="r-total"><td>‡∏£‡∏ß‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å: ${tq.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</td></tr></table></div>`;
  }

  // DEPT BY MONTH
  else if(type==='dept_month'){
    const data=filterD(dispatches);
    const mdMap={};
    data.forEach(d=>{
      const ym=d.date.slice(0,7);
      if(!mdMap[ym])mdMap[ym]={};
      if(!mdMap[ym][d.dest])mdMap[ym][d.dest]={};
      if(!mdMap[ym][d.dest][d.productId])mdMap[ym][d.dest][d.productId]=0;
      mdMap[ym][d.dest][d.productId]+=d.qty;
    });
    const months=Object.keys(mdMap).sort();
    const allDepts=[...new Set(data.map(d=>d.dest))].sort();

    html+=rh('‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',`‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dRange} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${now}`);

    if(!months.length){
      html+='<p style="text-align:center;padding:32px;color:#888">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    } else {
      // === ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ ===
      html+=`<div class="r-section">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å √ó ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>`;
      html+=`<table><thead><tr><th>‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>${months.map(ym=>{const[y,m]=ym.split('-');return`<th>${MTH[+m-1]} ${+y+543}</th>`;}).join('')}<th>‡∏£‡∏ß‡∏°</th></tr></thead><tbody>`;
      allDepts.forEach(dept=>{
        const row=months.map(ym=>Object.values(mdMap[ym]?.[dept]||{}).reduce((a,v)=>a+v,0));
        const grand=row.reduce((a,v)=>a+v,0);
        html+=`<tr><td style="font-weight:600">${dept}</td>${row.map(v=>`<td style="text-align:right">${v>0?v.toLocaleString():'-'}</td>`).join('')}<td style="text-align:right;font-weight:700;background:#dbeafe">${grand.toLocaleString()}</td></tr>`;
      });
      // footer row
      const colTotals=months.map(ym=>Object.values(mdMap[ym]||{}).reduce((a,dm)=>a+Object.values(dm).reduce((b,v)=>b+v,0),0));
      const grandTotal=colTotals.reduce((a,v)=>a+v,0);
      html+=`<tr style="background:#eef2f7;font-weight:700"><td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>${colTotals.map(v=>`<td style="text-align:right">${v.toLocaleString()}</td>`).join('')}<td style="text-align:right">${grandTotal.toLocaleString()}</td></tr>`;
      html+=`</tbody></table>`;

      // === ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ===
      months.forEach((ym,mi)=>{
        const[y,m]=ym.split('-');
        const mLabel=`${MTHF[+m-1]} ${+y+543}`;
        if(mi>0) html+=`<div class="page-break"></div>`;
        html+=`<div class="r-section" style="margin-top:${mi===0?'16px':'8px'}">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${mLabel}</div>`;
        html+=`<table><thead><tr><th>‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th></tr></thead><tbody>`;

        let hasRow=false;
        allDepts.forEach(dept=>{
          const dmap=mdMap[ym]?.[dept]; if(!dmap)return;
          hasRow=true;
          const pids=Object.keys(dmap).map(Number);
          const deptTotal=pids.reduce((a,pid)=>a+dmap[pid],0);
          pids.forEach((pid,ri)=>{
            const p=products.find(x=>x.id===pid);
            html+=`<tr>`;
            if(ri===0) html+=`<td rowspan="${pids.length}" style="font-weight:600;vertical-align:top;background:#f8fafc">${dept}</td>`;
            html+=`<td style="font-family:'IBM Plex Mono',monospace">${p?p.code:'-'}</td><td>${p?p.name:'-'}</td><td style="text-align:center">${p?p.unit:'-'}</td><td style="text-align:right;font-weight:600">${dmap[pid].toLocaleString()}</td></tr>`;
          });
          html+=`<tr style="background:#f0f4f8"><td colspan="3" style="text-align:right;font-style:italic;color:#555">‡∏£‡∏ß‡∏° ${dept}</td><td style="text-align:right;font-weight:700">${deptTotal.toLocaleString()}</td></tr>`;
        });
        if(!hasRow) html+=`<tr><td colspan="5" style="text-align:center;color:#888;padding:12px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;

        const mTotal=Object.values(mdMap[ym]||{}).reduce((a,dm)=>a+Object.values(dm).reduce((b,v)=>b+v,0),0);
        html+=`</tbody><tfoot><tr style="background:#dbeafe;font-weight:700"><td colspan="4" style="text-align:right">‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${mLabel}</td><td style="text-align:right">${mTotal.toLocaleString()}</td></tr></tfoot></table>`;
      });
    }
  }

  // LOW STOCK
  else if(type==='lowstock'){
    const data=products.filter(p=>(!fp||p.id==fp)&&p.stock<=p.minStock);
    html+=rh('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥ / ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: '+now);
    if(!data.length){html+='<p style="text-align:center;padding:32px;color:#888">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>';}
    else{
      html+=`<table><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Ç‡∏≤‡∏î</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th></tr></thead><tbody>`;
      html+=data.map((p,i)=>{const def=Math.max(0,p.minStock-p.stock); return`<tr><td style="text-align:center">${i+1}</td><td style="font-family:'IBM Plex Mono',monospace">${p.code}</td><td>${p.name}</td><td style="text-align:center">${p.category}</td><td style="text-align:right;color:#c0392b;font-weight:700">${p.stock}</td><td style="text-align:right">${p.minStock}</td><td style="text-align:right;font-weight:700;color:#e67e22">${def}</td><td style="text-align:center">${p.unit}</td></tr>`;}).join('');
      html+=`</tbody></table>`;
      html+=`<div class="r-summary"><table><tr class="r-total"><td>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></table></div>`;
    }
  }

  html+='</div>';
  document.getElementById('reportOutput').innerHTML=html;
}

function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.modal-bg').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');});});

renderDashboard();
</script>
</body>
</html>